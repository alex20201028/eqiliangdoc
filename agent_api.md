<center><h1>易起量手机话费商户接口说明书</h1></center>

------



| 编号 | 日期       | 版本号 | 修改内容                               | 修改人员 |
| ---- | ---------- | ------ | -------------------------------------- | -------- |
| 1    | 2015-10-01 | v0.01  | 初稿                                   | Edison   |
| 2    | 2016-10-25 | V0.02  | 增加商户回调功能                       | Edison   |
| 3    | 2016-10-27 | V0.03  | 修改回调sing参与字段，其他文字说明增加 | Edison   |

[TOC]



## 1. 引言

### 1.1 目的

对合作商接口进行详细描述。

### 1.2 名词解释

商户：所有通过本系统接入的企业或个人统称为商户，每个商户在本系统中拥有唯一的商户编号。

### 1.3  规范

订单防重：在一个商户的交易日内，对每一个订单，应有唯一的订单号。商户号、商户订单日期、商户订单号决定唯一一笔订单。

重复下单：异常情况下商户重复下单，系统会返回相关错误信息。商户收到此信息请发起查询交易确定该笔订单状态，切勿直接当作失败处理。

------



## 2. 接口基础说明

### 2.1 基本约定

接口以HTTP方式开放。

商户通过数据流方式向接口发送数据。

编码方式为UTF-8。

### 2.2 报文协议

报文为JSON格式。请求报文包括基本元素（header）与业务元素（body），响应报文包括结果元素（result）与业务元素（body），业务元素详见接口详细说明。

#### 2.21  基本元素（header）

| 参数名称 | 参数编码  | 是否必须 | 描述和案例                 |
| -------- | --------- | -------- | -------------------------- |
| 商户编号 | AgentID   | 是       | 商户在系统中开设的唯一编号 |
| 时间戳   | Timestamp | 是       | 时间戳，格式yyyyMMddHHmmss |
| 签名     | Sign      | 是       | Md5签名，详见签名机制      |

#### 2.22  结果元素（result）

| 参数名称     | 参数编码 | 是否必须 | 描述和案例       |
| ------------ | -------- | -------- | ---------------- |
| 交易结果代码 | Code     | 是       | 详见交易结果代码 |
| 交易结果描述 | Msg      | 否       |                  |

#### 2.23  示例

请求报文：

```
{
    "header": {
        "AgentID": "8888",
        "Timestamp": "20151001121225",
        "Sign": "dg4e84d5e8d459fe45glsirm78f4rs58"
    },
    "body": {
        ......// 具体业务元素
    }
}
```

响应报文：

```
{
    "result": {
        "Code":"0",
        "Msg":"成功下单，准备充值"
    },
    "body": {
        ......// 具体业务元素
    }
}
```

### 2.3 接口安全

签名使用MD5算法。

商户开通后可申请绑定来源IP。

#### 2.3.1 签名机制

将基本元素与业务元素中的所有子元素（sign除外）按照“value1+value2+value3+value4+value5+value6”的格式拼接起来，拼接时直接将值连接起来。最后将**key**值放在末尾对组装好的字符串做MD5签名。

示例：

```
MD5(AgentID+Timestamp+AgentOrderID+GoodsTypeID+GoodsID+PayNumber+Amount+key)
```

------



## 3. 接口详细说明

### 3.1 话费充值下单

此接口用于将订单提交到系统。

请求地址：

```
http://[ip:prot]/toAgentNew.asp
```

```
MD5(AgentID + Timestamp + AgentOrderID + GoodsTypeID + GoodsID + PayNumber + Amount + key)
```

#### 3.1.1 请求参数

| 参数名称     | 参数编码     | 是否必须 | 描述和案例             |
| ------------ | ------------ | -------- | ---------------------- |
| 商户订单号   | AgentOrderID | 是       | 商户交易订单号         |
| 商品类型编号 | GoodsTypeID  | 是       | 手机话费快充传值：101  |
| 商品编号     | GoodsID      | 是       | 手机话费充值传值：0000 |
| 缴费号码     | PayNumber    | 是       | 充值的客户号码         |
| 缴费面额     | Amount       | 是       | 充值面额，单位：元     |

#### 3.1.2 请求示例

```
{
  "header": {
......// 具体基本元素
  },
  "body": {
"AgentOrderID":"2015100100001",
     "GoodsTypeID":"101",
     "GoodsID":"0000",
     "PayNumber":"13818001800",
"Amount ": "100"
  }
}
```

#### 3.1.3 响应参数

交易结果代码为0仅表示本次请求成功下单，准备充值，不表示充值成功。充值结果通过商户主动发起查询交易查询。

| 参数名称     | 参数编码      | 是否必须 | 描述和案例                 |
| ------------ | ------------- | -------- | -------------------------- |
| 商户订单号   | AgentOrderID  | 是       | 商户交易订单号             |
| 平台订单号   | SystemOrderID | 是       | 平台订单号                 |
| 缴费面额     | Amount        | 是       | 缴费面额，单位：元         |
| 商户支付金额 | AgentPrice    | 是       | 实际商户支付金额，单位：元 |

#### 3.1.4 响应示例

```
{
  "result": {
......// 具体结果元素
  },
  "body": {
     "AgentOrderID": "2015010188888888",
     "SystemOrderID": "2015010188888888",
     "Amount": "100",
     "AgentPrice": "99.6"
  }
}
```

### 3.2 订单结果查询

此接口用于查询订单状态

请求地址：

```
http://[ip:prot]/toAgentQuery.asp
```

```
MD5(AgentID + Timestamp + AgentOrderID + GoodsTypeID + key)
```

接口仅可查询72小时内订单，超过该时间订单请人工查询。

#### 3.2.1 请求参数

| 参数名称     | 参数编码     | 是否必须 | 描述和案例            |
| ------------ | ------------ | -------- | --------------------- |
| 商户订单号   | AgentOrderID | 是       | 商户交易订单号        |
| 商品类型编号 | GoodsTypeID  | 是       | 手机话费快充传值：101 |

#### 3.2.2 请求示例

```
{
    "header": {
......// 具体基本元素
    },
    "body": {
        "AgentOrderID": "2015010188888888"
        "GoodsTypeID": "101"
    }
}
```

#### 3.2.3 响应参数

| 参数名称     | 参数编码      | 是否必须 | 描述和案例             |
| ------------ | ------------- | -------- | ---------------------- |
| 商户订单号   | AgentOrderID  | 是       | 商户交易订单号         |
| 平台订单号   | SystemOrderID | 是       | 平台订单号             |
| 商品类型编号 | GoodsTypeID   | 是       | 商品类型编号           |
| 商品编号     | GoodsID       | 是       | 商品编号               |
| 缴费号码     | PayNumber     | 是       | 缴费号码               |
| 缴费面额     | Amount        | 是       | 缴费面额，单位：元     |
| 商户支付金额 | AgentPrice    | 是       | 商户支付金额，单位：元 |

#### 3.2.4 响应示例

```
{
    "result": {
......// 具体结果元素
    },
    "body": {
        "AgentOrderID": "2015010188888888",
        "SystemOrderID": "2015010188888888",
        "GoodsTypeID": "101",
        "GoodsID": "601",
        "PayNumber ": "13818001800",
        "Amount ": "100",
        "AgentPrice ": "99.6"
    }
}
```

### 3.3 账户查询

此接口用于查询代理商资金余额。

接口地址：

```
http://[ip:prot]/toAgentBalance.asp
```

```
MD5(AgentID + Timestamp + QueryType + key)
```

#### 3.3.1 请求参数

| 参数名称 | 参数编码  | 是否必须 | 描述和案例      |
| -------- | --------- | -------- | --------------- |
| 查询类型 | QueryType | 是       | 1：账户实时余额 |

#### 3.3.2 请求示例

```
{
    "header": {
......// 具体基本元素
    },
    "body": {
        "QueryType": "1"
    }
}
```

#### 3.3.3 响应参数

| 参数名称 | 参数编码  | 是否必须 | 描述和案例         |
| -------- | --------- | -------- | ------------------ |
| 查询类型 | QueryType | 是       | 1：账户实时余额    |
| 账户余额 | Balance   | 是       | 账户余额，单位：元 |

#### 3.3.4 响应示例

```
{
    "result": {
......// 具体结果元素
    },
"body": {
"QueryType": "1",
        "Balance": "999999.12",
    }
}
```

### 3.4 异步通知接口

平台对商户的业务请求处理完成后，会将处理的最终结果通过服务器主动通知至商户提供的异步通知地址。

商户的异步通知地址，需对接时候告知平台，平台配置后才会通知。

平台将结果生成JSON格式POST到商户的异步通知网址。

通知机制：最多通知5次，时间间隔为2分钟。

#### 3.4.1 请求参数

| 参数名称     | 参数编码      | 是否必须 | 描述和案例                                                   |
| ------------ | ------------- | -------- | ------------------------------------------------------------ |
| 交易结果代码 | Code          | 是       |                                                              |
| 交易结果描述 | Msg           | 是       |                                                              |
| 校验码       | Sign          | 是       | MD5(Code+ AgentID + AgentOrderID + OrderID + GoodsTypeID + GoodsID + PayNumber + key) |
| 商户号       | AgentID       | 是       | 商户号                                                       |
| 商户订单号   | AgentOrderID  | 是       | 商户订单号                                                   |
| 平台订单号   | SystemOrderID | 是       | 平台订单号                                                   |
| 商品类型编号 | GoodsTypeID   | 是       | 商品类型编号                                                 |
| 商品编号     | GoodsID       | 是       | 商品编号                                                     |
| 缴费号码     | PayNumber     | 是       | 缴费号码                                                     |
| 缴费面额     | Amount        | 是       | 缴费面额，单位：元                                           |
| 商户支付金额 | AgentPrice    | 是       | 商户支付金额，单位：元                                       |

#### 3.4.2 请求示例

```
{
    "result": {
        "Code": "8",
        "Msg": "充值成功",
        "Sign": "45sjskuehaldhgjsielmvnsbriejslafsj"
    },
    "body": {
        "AgentID": "8000",
"AgentOrderID": "2015010188888888",
        "SystemOrderID": "2015010188888888",
        "GoodsTypeID": "101",
        "GoodsID": "601",
        "PayNumber ": "13818001800",
        "Amount ": "100",
        "AgentPrice ": "99.6"
    }
}
```

#### 3.4.3 响应参数

商户成功接受通知后请返回字符串SUCCESS，否则继续通知，直至通知机制完成。

------



## 4. 数据字典

### 4.1 交易结果代码

以下为交易结果返回Code值说明：

| 错误编码 | 错误信息                                                     | 错误信息                                    |
| -------- | ------------------------------------------------------------ | ------------------------------------------- |
| 0        | 成功下单，准备充值                                           | 仅代表订单提交成功，需进行订单查询确认      |
| 6        | 成功下单，商户订单号已存在                                   | 说明该商户订单号系统已存在                  |
| 1        | 充值中                                                       | 充值处理中                                  |
| 8        | 充值成功                                                     | 查询账户余额时代表查询余额成功              |
| 4        | 充值失败，已退款                                             |                                             |
| 4000     | 系统维护，暂停下单                                           |                                             |
| 4001     | 数据非法，请核实                                             |                                             |
| 4002     | 数据有误，参数 *****                                         | ******代表各种参数                          |
| 4003     | A、商户账号异常，请联系管理员B、商户账号冻结/停用C、商户接口已关闭 | 该代码错误，可能有这三种错误，详见返回的Msg |
| 4004     | 商户IP来源非法                                               |                                             |
| 4005     | 商户签名Sign校验不正确                                       |                                             |
| 4006     | 数据有误，传输问题                                           |                                             |
| 4010     | 该手机号不支持充值                                           | 可联系客服进一步确认该号码是否支持          |
| 4011     | 系统不支持该商品充值                                         |                                             |
| 4020     | 商品编号异常                                                 | 商品编号不存在                              |
| 4021     | 商户货架无该商品                                             | 代理商货架无该商品                          |
| 4022     | 商户货架该商品已下架                                         | 代理商货架该商品已下架                      |
| 4023     | 商户货架该商品价格异常                                       | 代理商货架商品价格异常                      |
| 4024     | 商户账户余额不足                                             |                                             |
| 4030     | 该手机号为空号或被禁止充值                                   | 黑名单或被手动禁止的                        |
| 4031     | 该手机号充值已达上限                                         |                                             |
| 4040     | 下单失败，数据库异常                                         | 需进一步人工核实                            |
| 4050     | 商户订单不存在                                               | 需进一步人工核实                            |




## 5. 对账

对账文件通过商户平台下载

